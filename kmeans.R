######## 用K均值聚类探寻青少年市场细分 ##########
## 1. 数据清洗
('<-' (teens, (read.csv ("http://127.0.0.1:8003/snsdata.csv"))))

(table (teens$gender, useNA="ifany"))
##     F     M  <NA> 
## 22054  5222  2724 

(summary (teens$age)) ## 有NA的缺失值
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
##   3.086  16.312  17.287  17.994  18.259 106.927    5086 

## 提取13~20岁的数据, 否则赋值为NA
('<-' (teens$age, (ifelse (('&' (('>=' (teens$age, 13)), ('<' (teens$age, 20)))), teens$age, NA))))

(summary (teens$age)) ## 年龄大概的数据特征
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
##   13.03   16.30   17.27   17.25   18.22   20.00    5523 
## 

## 创建性别虚拟变量: is.na 是用来检测性别是否等于NA, TRUE就是1, 否则0
('<-' (teens$female, (ifelse (('&' (('==' (teens$gender, "F")), ('!' ((is.na (teens$gender)))) )), 1, 0))))

('<-' (teens$no_gender, (ifelse (((is.na (teens$gender))), 1, 0))))

(table (teens$female, useNA="ifany"))
##     F     M  <NA> 
## 22054  5222  2724 
(table (teens$no_gender, useNA="ifany"))
##     0     1 
## 27276  2724 

## 数据插补缺失值
(mean (teens$age))
# [1] NA

## 去除NA的数据,平均年龄为17岁
(mean (teens$age, na.rm=TRUE))
## [1] 17.25243

## 毕业年级年龄 
(aggregate (data=teens, age ~ gradyear, mean, na.rm=TRUE))
##   gradyear      age
## 1     2006 18.65586
## 2     2007 17.70617
## 3     2008 16.76770
## 4     2009 15.81957

## ave函数返回一个具有重复的组均值的向量,使得结果在长度上等于原始向量的长度

('<-' (ave_age, (ave (teens$age, teens$gradyear, FUN=(function (x) (mean (x, na.rm=TRUE))))))) #=>
## [29985] 15.81957 15.81957 15.81957 15.81957 15.81957 15.81957 15.81957 15.81957
## [29993] 15.81957 15.81957 15.81957 15.81957 15.81957 15.81957 15.81957 15.81957

## NA的地方替换为 15.81957
('<-' (teens$age, (ifelse (((is.na (teens$age))), ave_age, teens$age))))

(summary (teens$age)) # 没有缺失值了
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   13.03   16.28   17.24   17.24   18.21   20.00 
## 

## 2. 数据训练模型
## 只是取36个特征:
('<-' (interests, (teens [5:40])))

('<-' (interests_z, (as.data.frame (lapply (interests, scale)))))

## k均值聚类:
('<-' (teen_clusters, (kmeans (interests_z, 5)))) 
##  K-means clustering with 5 clusters of sizes 868, 5089, 2528, 986, 20529
##  
##  Cluster means:
##     basketball    football      soccer    softball  volleyball   swimming
##  1  0.14167017  0.22213753  0.10379744  0.02815663  0.16699415  0.2392009
##  2 -0.04333395  0.02926412  0.05106097 -0.07102037 -0.06215112  0.2930632
##  3  1.40597741  1.25519234  0.46915253  1.17513976  1.09542991  0.1042402
##  4  0.34332617  0.36267270  0.11427889  0.13033068  0.08696035  0.2598940
##  5 -0.18487378 -0.18863374 -0.08030796 -0.13455486 -0.13072500 -0.1080812
##    cheerleading   baseball      tennis      sports          cute           sex
##  1   0.39745979  0.0196924  0.13637546  0.09662301  0.3772355687  0.0217809425
##  2   0.28055779 -0.0858758  0.07775567 -0.09147282  0.6391215094  0.0004133618
##  3   0.09877531  1.2212449  0.11494681  1.09007796  0.0003909484 -0.0304072525
##  4   0.16930409  0.2207055  0.11749380  0.77073031  0.4836325331  2.1056013259
##  5  -0.10664872 -0.1405326 -0.04483935 -0.15266310 -0.1976608617 -0.0984101919
##            sexy         hot      kissed        dance        band    marching
##  1  0.118735199  0.41623474  0.06655066  0.224905488 -0.08861319 -0.09326362
##  ..............
##  Within cluster sum of squares by cluster:
##  [1]  55457.33 343170.76 152973.98 175921.57 220008.24
##   (between_SS / total_SS =  12.3 %)
##  
##  Available components:
##  
##  [1] "cluster"      "centers"      "totss"        "withinss"     "tot.withinss"
##  [6] "betweenss"    "size"         "iter"         "ifault"      
##  

## 3. 评估性能
## 看到分出来5类,各自的数量如下
(teen_clusters$size)
# [1]   868  5089  2528   986 20529

(teen_clusters$centers) #===>> 分量teen_clusters$centers查看聚类质心的坐标,所有的特征如下 ==>>
##     basketball    football      soccer    softball  volleyball   swimming
##  1  0.14167017  0.22213753  0.10379744  0.02815663  0.16699415  0.2392009
##  2 -0.04333395  0.02926412  0.05106097 -0.07102037 -0.06215112  0.2930632
##  3  1.40597741  1.25519234  0.46915253  1.17513976  1.09542991  0.1042402
##  4  0.34332617  0.36267270  0.11427889  0.13033068  0.08696035  0.2598940
##  5 -0.18487378 -0.18863374 -0.08030796 -0.13455486 -0.13072500 -0.1080812
##    cheerleading   baseball      tennis      sports          cute           sex
##  1   0.39745979  0.0196924  0.13637546  0.09662301  0.3772355687  0.0217809425
##  2   0.28055779 -0.0858758  0.07775567 -0.09147282  0.6391215094  0.0004133618
##  3   0.09877531  1.2212449  0.11494681  1.09007796  0.0003909484 -0.0304072525
##  4   0.16930409  0.2207055  0.11749380  0.77073031  0.4836325331  2.1056013259
##  5  -0.10664872 -0.1405326 -0.04483935 -0.15266310 -0.1976608617 -0.0984101919
##            sexy         hot      kissed        dance        band    marching
##  1  0.118735199  0.41623474  0.06655066  0.224905488 -0.08861319 -0.09326362
##  2  0.257224087  0.43829800 -0.02129026  0.584707319  0.46550194  0.40067408
##  3  0.008272515  0.01399777 -0.08689738 -0.009806553 -0.07544798 -0.07390379
##  4  0.546791238  0.30728406  3.10478416  0.421169428  0.42478899  0.05994389
##  5 -0.096065303 -0.14273266 -0.13595696 -0.173475357 -0.12275964 -0.08915941
##          music        rock          god      church        jesus       bible
##  1  0.14586276  0.06842745  0.035267938 -0.01161520  0.015301587 -0.03669010
##  2  0.39887808  0.20940523  0.435375791  0.58125939  0.352560963  0.32592854
##  3  0.04951303  0.16081062  0.007574811  0.09705577 -0.008367237 -0.03659211
##  4  1.13496832  1.17568053  0.408642171  0.17061756  0.105484524  0.06921067
##  5 -0.16565576 -0.13107353 -0.129977606 -0.16374558 -0.092080466 -0.07806226
##           hair       dress      blonde        mall    shopping     clothes
##  1  0.44616998  0.15298455  0.06176156  0.60870187  0.79614983  0.57306801
##  2  0.26998775  0.54752554  0.01462176  0.54007840  0.76946736  0.45162742
##  3  0.02008601 -0.06471161  0.04356182  0.01044819  0.03746929  0.01472339
##  4  2.54884945  0.51808596  0.36574690  0.61694756  0.26313226  1.20933731
##  5 -0.21068665 -0.15911101 -0.02916703 -0.19053707 -0.24166049 -0.19608272
##      hollister abercrombie         die       death       drunk       drugs
##  1  4.14729831  3.98339549  0.04833458  0.09981960  0.03938611  0.03849076
##  2 -0.06491048 -0.07548349  0.09254252  0.20094291  0.02822921 -0.05206288
##  3 -0.08968479 -0.10944894 -0.07373103 -0.03149905 -0.06777067 -0.09133078
##  4  0.16410482  0.25957493  1.75304512  0.93425619  1.89121987  2.85135813
##  5 -0.15610160 -0.14870212 -0.10010296 -0.09502601 -0.09115223 -0.11442432
##  
